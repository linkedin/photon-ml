def jobDir = "conf/jobs"

// Have this script clean up the jobDir on ligradle clean.
clean {
  delete jobDir
}

def flowName = "latent-facor-game-on-jymbii-4-month-parameter-tuning-50"

def trainInputDirs = "/jobs/liar/yma/jymbii-batch-wk/v2_data/glmix_data_20000,/jobs/liar/yma/jymbii-batch/v2_data/" +
    "glmix_data_20000"
def validateInputDirs = "/jobs/liar/yma/jymbii-batch/v2_data/glmix_data_20000"

def trainDateRange = "20150707-20151103"
def validateDateRange = "20151104-20151110"


def featureNameAndTermSetInputPath = "/jobs/liar/jymbii-glmm/glmix/feature-lists/" +
    "globalFeatures-memberFeatures-jobFeatures-memberJobCrossFeatures-20150707-20151103"

def featureShardIdToFeatureSectionKeysMap = "shard1:globalFeatures,memberFeatures,jobFeatures,memberJobCrossFeatures|" +
    "shard2:globalFeatures,jobFeatures|shard3:globalFeatures,memberFeatures"

def outputDir = "/tmp/liar/jobs/liar/$flowName" as String


def numIterations = 4
def updatingSequence = "global,per-member-factor,per-member,per-job-factor,per-job"
def fixedEffectOptimizationConfigurations = "global:10,1e-5,10,0.5,tron,l2"
def fixedEffectDataConfigurations = "global:shard1"

def perMemberRandomEffectRegularizationWeights = [50]
def perJobRandomEffectRegularizationWeights = [50]

def factorRegularizationWeightRatios = [1]

def numFeaturesToNumObservationsRatios = [20]
def numLatentDimensions = [50]
def numLatentFactorGameInnerIterations = 1
def downSamplingRateForLatentFactorMatrixUpdate = 0.2


hadoop {
  buildPath jobDir

  workflow(flowName) {

    for (factorRegularizationWeightRatio in factorRegularizationWeightRatios) {
      for (numLatentDimension in numLatentDimensions) {
        for (numFeaturesToNumObservationsRatio in numFeaturesToNumObservationsRatios) {
          for (perMemberRandomEffectRegularizationWeight in perMemberRandomEffectRegularizationWeights) {
            for (perJobRandomEffectRegularizationWeight in perJobRandomEffectRegularizationWeights) {

              if (perMemberRandomEffectRegularizationWeight > perJobRandomEffectRegularizationWeight) {
                continue
              }

              def perMemberFactorRandomEffectRegularizationWeight = perMemberRandomEffectRegularizationWeight / factorRegularizationWeightRatio
              def perJobFactorRandomEffectRegularizationWeight = perJobRandomEffectRegularizationWeight / factorRegularizationWeightRatio

              def factoredRandomEffectOptimizationConfigurations = "" +
                  "per-member-factor:10,1e-5,$perMemberFactorRandomEffectRegularizationWeight,1,tron,l2" +
                  ":5,1e-4,10,$downSamplingRateForLatentFactorMatrixUpdate,tron,l2:$numLatentFactorGameInnerIterations,$numLatentDimension" +
                  "|per-job-factor:5,1e-5,$perJobFactorRandomEffectRegularizationWeight,1,tron,l2" +
                  ":5,1e-4,10,$downSamplingRateForLatentFactorMatrixUpdate,tron,l2" +
                  ":$numLatentFactorGameInnerIterations,$numLatentDimension"

              def randomEffectDataConfigurations = "per-member-factor:memberId,shard2,-1,-1,-1,identity" +
                  "|per-member:memberId,shard2,-1,-1,$numFeaturesToNumObservationsRatio,index_map" +
                  "|per-job-factor:jobId,shard3,-1,-1,-1,identity" +
                  "|per-job:jobId,shard3,-1,-1,$numFeaturesToNumObservationsRatio,index_map"

              def randomEffectOptimizationConfigurations =
                  "per-member:10,1e-5,$perMemberRandomEffectRegularizationWeight,1,tron,l2" +
                      "|per-job:10,1e-5,$perJobRandomEffectRegularizationWeight,1,tron,l2"

              def applicationName = "member-$perMemberRandomEffectRegularizationWeight-member-fac-$perMemberFactorRandomEffectRegularizationWeight-job-$perJobRandomEffectRegularizationWeight-job-fac-$perJobFactorRandomEffectRegularizationWeight-ratio-$numFeaturesToNumObservationsRatio-dim-$numLatentDimension"
                  .replaceAll("\\.|_|,", "-") as String

              job(applicationName) {

                def executorMemoryInMB = 8000
                def executorMemory = "${executorMemoryInMB}m" as String
                def executorMemoryOverhead = executorMemoryInMB / 4
                def numExecutors = 300
                def driverMemoryInMB = 10000
                def driverMemory = "${driverMemoryInMB}m" as String
                def parallelism = numExecutors * 4
                def maxResultSize = "${driverMemoryInMB/2}m" as String

                def jobOutputDir = "$outputDir/$applicationName" as String

                baseProperties 'sparkCommon'
                set properties: ['class'                                  : 'com.linkedin.mlease.spark.avro.training.Driver',
                                 'num-executors'                          : numExecutors,
                                 'driver-memory'                          : driverMemory,
                                 'executor-memory'                        : executorMemory,
                                 'conf.spark.yarn.executor.memoryOverhead': executorMemoryOverhead,
                                 'conf.spark.default.parallelism'         : parallelism,
                                 'conf.spark.driver.maxResultSize'        : maxResultSize,
                                 'params'                                 : "--train-input-dirs $trainInputDirs " +
                                     "--task-type binary_classification " +
                                     "--validate-input-dirs $validateInputDirs " +
                                     "--train-date-range $trainDateRange " +
                                     "--validate-date-range $validateDateRange " +
                                     "--output-dir $jobOutputDir " +
                                     "--feature-name-and-term-set-path $featureNameAndTermSetInputPath " +
                                     "--feature-shard-id-to-feature-section-keys-map $featureShardIdToFeatureSectionKeysMap " +
                                     "--num-iterations $numIterations " +
                                     "--updating-sequence $updatingSequence " +
                                     "--fixed-effect-optimization-configurations $fixedEffectOptimizationConfigurations " +
                                     "--fixed-effect-data-configurations $fixedEffectDataConfigurations " +
                                     "--random-effect-optimization-configurations $randomEffectOptimizationConfigurations " +
                                     "--factored-random-effect-optimization-configurations $factoredRandomEffectOptimizationConfigurations " +
                                     "--random-effect-data-configurations $randomEffectDataConfigurations " +
                                     "--application-name $applicationName "]
              }
              targets applicationName
            }
          }
        }
      }
    }
  }
}